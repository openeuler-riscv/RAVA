## 为当前设备添加一个 Device Type

![添加设备类型 bpi_f3](./imgs/add_device_type_bpi_f3.png "添加设备类型 bpi_f3")

![Administration > Device Type > + Add](./imgs/set_bpi_f3_type.png "设置 bpi_f3 类型")

> Architecture 和 Processor 需要点击右侧 + 号添加，缺少的部分可以补充也可以留空

## 安装 tftp 并配置

k1-bananapi-f3 虽然不通过 tftp 获取并加载固件，内核，设备树相关文件，但在 deploy 阶段会将 kernel 下载到 tftp 相关目录，并且在启动阶段需要 pxeboot 加载 tftp 的启动文件，所以需要先在 worker 机器上安装并配置 tftp。安装 lava-dispatcher 时应该会默认安装 tftpd-hpa ，若没有则：

```Bash
sudo apt install tftpd-hpa
```

tftp 配置文件类似于：

```TypeScript
zhtianyu@debian:~$ cat /etc/default/tftpd-hpa  
# /etc/default/tftpd-hpa 

TFTP_USERNAME="tftp" 
TFTP_DIRECTORY="/srv/tftp" 
TFTP_ADDRESS=":69" 
TFTP_OPTIONS="--secure"
```

## 安装 NFS server 并配置

k1-bananapi-f3 通过 NFS 的方式获取文件系统相关文件，需要在 worker 安装并配置 NFS server。安装 lava-dispatcher 时应该会默认安装 nfs-kernel-server ，若没有则：

```Bash
sudo apt install nfs-kernel-server
```

lava 默认会在`/etc/exports.d/lava-dispatcher-nfs.exports`配置 NFS 共享目录：

```Shell
zhtianyu@debian:~$ cat /etc/exports.d/lava-dispatcher-nfs.exports 
# /etc/exports: the access control list for filesystems which may be exported 
#               to NFS clients.  See exports(5). 
# 
# Example for NFSv2 and NFSv3: 
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check) 
# 
# Example for NFSv4: 
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check) 
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check) 
# 

/var/lib/lava/dispatcher/tmp *(rw,no_root_squash,async,no_subtree_check,crossmnt)
```

若没有配置，则：

```Plain
vim /etc/exports    
/var/lib/lava/dispatcher/tmp *(rw,no_root_squash,no_all_squash,async,no_subtree_check)
sudo service nfs-kernel-server restart   # 配置完成后重启 NFS server
```

### 准备 persistent\_nfs

由于 k1-bananapi-f3 的启动流程的限制，采用 persistent\_nfs 作为 k1-bananapi-f3 的 rootfs，需要在上述的 nfs 共享目录下准备 **k1\_rootfs**

```Shell
wget https://repo.tarsier-infra.isrc.ac.cn/openEuler-RISC-V/RVCK/openEuler24.03-LTS-SP1/openeuler-rootfs.tar.gz
sudo tar -xvf ../openeuler-rootfs.tar.gz -C /var/lib/lava/dispatcher/tmp/k1_rootfs
```

同时，需要清理上次测试的残留，需要每次启动测试前删除`/var/lib/lava/dispatcher/tmp/k1_rootfs`目录，并解压出一个干净的 rootfs 。可以在 worker 上准备一个 pre\_os\_command 脚本，在 job 中定义每次启动测试前执行 pre\_os\_command：

```Bash
zhtianyu@debian:~$ cat k1/reset_nfsrootfs  
#!/bin/bash 

sudo -S rm -rf /var/lib/lava/dispatcher/tmp/k1_rootfs << EOF 
zhtianyu\r 
EOF 
sudo -S mkdir /var/lib/lava/dispatcher/tmp/k1_rootfs << EOF 
zhtianyu\r 
EOF 
sudo -S tar -zxf /home/zhtianyu/k1/openeuler-rootfs.tar.gz -C /var/lib/lava/dispatcher/tmp/k1_rootfs << EOF 
zhtianyu\r 
EOF
```

## 在服务端添加 Worker 连接的 Device

在 LAVA 服务端命令行执行

`lava-server manage devices add --device-type spacemit-k1-bananapi-f3 --worker cipu-zz-debian-01 k1-bananapi-f3-01`

执行成功后在 Web 界面`Scheduler > Devices`可以查询到

![查看 bpi_f3 设备](./imgs/bpi_f3_device.png "查看 bpi_f3 设备")

## 为 spacemit-k1-bananapi-f3 添加 device-type 基础模板

将 spacemit-k1-bananapi-f3 的 device-type 存储在 server 下的 `/etc/lava-server/dispatcher-config/device-types/spacemit-k1-bananapi-f3.jinja2` 中

```YAML
{# device_type = "spacemit-k1-bananapi-f3" #} 
{% extends 'base-uboot.jinja2' %} 

{% set uboot_mkimage_arch = 'riscv' %} 

{% set bootloader_prompt = bootloader_prompt|default('=>') %} 
{% set boot_character_delay = boot_character_delay | default(10) %} 

{% set console_device = console_device|default('ttySP0') %} 
{% set baud_rate = baud_rate|default(115200) %} 

{% set booti_kernel_addr  = '0x11000000' %} 
{% set booti_ramdisk_addr = '0x21000000' %} 
{% set booti_dtb_addr     = '0x31000000' %} 

{% set extra_kernel_args = "earlycon=sbi rootwait raid=noautodetect selinux=0 loglevel=7" %} 

{% set uboot_tftp_commands = [] %}
```

### 编写 device-type 模板的流程

首先可以到 [device-types](https://github.com/Linaro/lava/tree/master/etc/dispatcher-config/device-types) 查看是否有已存在的 device-type 模板，虽然官方有 spacemit-k1-bananapi-f3 的 device-type 文件，但在实际使用过程中发现无法正常启动，且 uboot 下无法使用 tftpboot 加载当前的 initramfs.img，而是通过 pxeboot 启动，需要配置相关的启动文件，这样就需要我们自己编写 device-type 了。以下为编写 spacemit-k1-bananapi-f3 的模板的步骤：

1. 了解板卡启动方式，目前 spacemit-k1-bananapi-f3 可以通过自动 pxeboot 启动（无需进入 uboot shell，直接默认加载 pxeboot 文件），具体的启动方式是在 worker 上配置 pxelinux 启动文件，在 spacemit-k1-bananapi-f3 启动后默认从 worker 上获取启动文件后启动，其中default 配置文件中写明 nfsroot=10.213.5.176:/var/lib/lava/dispatcher/tmp/k1\_rootfs,tcp,hard rw 用于启动时挂载 persistent\_nfs 。
2. 依托已存在的 `base-uboot.jinja2` ，对 spacemit-k1-bananapi-f3 的启动过程进行适配，只在 device-type 中做基础的配置，通过脚本生成需要的启动文件。

编写方法可以参考https://validation.linaro.org/static/docs/v2/device-integration.html，已有的 device-type 可以查看 https://github.com/Linaro/lava/tree/master/etc/dispatcher-config/device-types

> sg2042 通过 linuxboot 启动，但 lava 中对于该流程没有相关的适配，目前可以通过已存在的 device-type 和 job 中的相关定义完成启动流程。最合理的方式应该在 lava 中适配 linuxboot 的流程。不过适配可能需要大量的工作，暂且采用当前的方式完成接入。

### spacemit-k1-bananapi-f3 device-type 基础模板详解

1. ​**扩展基模板**​：
   ```YAML
   {% extends 'base-uboot.jinja2' %}
   ```
   
   1. 该行表示当前模板从 `base-uboot.jinja2` 继承
2. ​**设置变量**​：
   ```YAML
   {% set console_device = console_device|default('ttySP0') %}
   {% set baud_rate = baud_rate|default(115200) %}
   ```
   
   1. `console_device`：设置控制台设备，默认为 `ttyS0`，如果未传递其他值。需要注意的是，就 sg2042 而言，这里指的是 sg2042 的控制台设备，而不是 worker 连接 sg2042 的串口设备，保持 `ttyS0` 即可
   2. `baud_rate`：设置波特率，默认为 `115200`。
3. **设置**​**内存**​​**地址**​：
   ```YAML
   {% set booti_kernel_addr  = '0x11000000' %} 
   {% set booti_ramdisk_addr = '0x21000000' %} 
   {% set booti_dtb_addr     = '0x31000000' %}
   ```
   
   1. `booti_kernel_addr`：内核的加载地址。
   2. `booti_dtb_addr`：设备树 Blob (DTB) 的加载地址。
   3. `booti_ramdisk_addr`：初始 RAM 磁盘的加载地址。
   
   > 根据启动流程来说，并不需要这些​**加载地址**​，但如果不设置的话会报错：Invalid job data: ["Requested kernel boot type 'bootm' is not supported by this device."]
4. ​**设置 lava 输入字符的间隔**​：
   ```YAML
   {% set boot_character_delay = 10 %}
   ```
   
   1. `boot_character_delay`：设置 lava 输入字符的时间，主要是为了模拟人类键盘输入，电脑输入过快可能会造成字符倒置等情况

## 配置 k1-bananapi-f3 连接方式

这里选择使用串口连接

* 如果要使用远程设备，lava-dispatcher 的依赖中包括了`ser2net`，可以通过这个方式对设备进行访问

### 使用 ser2net 为串口打开一个网络连接

#### 安装 ser2net

```Shell
sudo apt install ser2net
sudo vim /etc/ser2net.yaml     //配置串口信息
```

#### 配置 ser2net

笔者使用的串口设备在`/dev/ttyACM1`，k1-bananapi-f3 的串口波特率为 115200

编辑文件`/etc/ser2net.yaml`，将其暴露在 15202 端口上

```yaml
connection: &con1152A1 
    accepter: tcp,localhost,15203 
    enable: on 
    options: 
      banner: *banner 
      kickolduser: true 
      telnet-brk-on-sync: true 
    connector: serialdev, 
              /dev/ttyACM1, 
              115200n,local
```

## 配置 k1-bananapi-f3 ha 控制开关机（需要线下协助）

将 k1-bananapi-f3 电源连接到 ha 的插座上，并获取对应的 entity\_id

将控制电源开关的 curl 命令保存到 worker 机器上，如 `/home/zhtianyu/bpi_f3/`

```Bash
zhtianyu@debian:~$ cat bpi_f3/power_on 
#!/bin/bash 

curl -X POST -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI1OWMyNzM3OWRjMDU0ZjlhOWFiZDU5ZDNiM2MzZGUxMC
IsImlhdCI6MTc0ODA2ODEzNSwiZXhwIjoyMDYzNDI4MTM1fQ.xltJlQbzS6qyVTGbbL6q1hVdaxODWfz_fbv78JNq6zc" -H "Content-Type: application/json" 
-d '{"entity_id":"switch.cuco_cn_631877811_cp1d_on_p_2_1"}' http://10.213.5.145:8123/api/services/switch/turn_on 

zhtianyu@debian:~$ cat bpi_f3/power_off 
#!/bin/bash 

curl -X POST -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI1OWMyNzM3OWRjMDU0ZjlhOWFiZDU5ZDNiM2MzZGUxMC
IsImlhdCI6MTc0ODA2ODEzNSwiZXhwIjoyMDYzNDI4MTM1fQ.xltJlQbzS6qyVTGbbL6q1hVdaxODWfz_fbv78JNq6zc" -H "Content-Type: application/json" 
-d '{"entity_id":"switch.cuco_cn_631877811_cp1d_on_p_2_1"}' http://10.213.5.145:8123/api/services/switch/turn_off 
zhtianyu@debian:~$ cat bpi_f3/hard_reset  
#!/bin/bash 
cd /home/zhtianyu/bpi_f3 || exit 1 
./power_off && sleep 10 && ./power_on
```

如果使用的是同样的电源控制方案，其中应填写与实际环境中一致的参数，如 `Authorization`，`entity_id`，以及对应的 `url` 地址。

## 配置 k1-bananapi-f3 的 pxelinux.cfg

k1-bananapi-f3 的启动方式是通过 pxeboot 启动的，启动时需要获取 pxelinux.cfg，需要在 pxelinux.cfg 下生成启动文件，首先在 /home/bpi\_f3/ 目录下初始化模板文件，为需要启动的 kernel ,initramfs.img 和 dtb 文件目录设置占位符，同时定义 nfsrootfs 的目录，nfsroot 中 10.213.5.176 为 worker 的 ip，/var/lib/lava/dispatcher/tmp/k1\_rootfs 为之前配置好的 persistent\_nfs 共享地址：

```Bash
zhtianyu@debian:~$ cat bpi_f3/01-fe-fe-fe-00-06-6e  
title openEuler Boot Menu 
prompt 0 
timeout 3 
default LAVA_MVP 

label LAVA_MVP 
    menu label openEuler | LAVA spacemit-k1 BPI-F3 
    linux {KERNEL} 
    initrd {INITRAMFS} 
    fdt {DTB} 
    append root=/dev/nfs nfsroot=10.213.5.176:/var/lib/lava/dispatcher/tmp/k1_rootfs,tcp,hard rw rootwait console=ttySP0,115200 ea
rlycon=sbi selinux=0 ip=dhcp
```

在 tftp 共享目录下初始化 pxelinux.cfg：

```Plain
sudo mkdir -p /srv/tftp/pxelinux.cfg/
```

编写 generate\_pxelinux 脚本用于生成 `/srv/tftp/pxelinux.cfg/01-fe-fe-fe-00-06-6e`：

```Bash
zhtianyu@debian:~$ cat bpi_f3/generate_pxelinux  
#!/bin/sh 
set -e 

env_file=$(ls -d /var/lib/lava/dispatcher/tmp/k1_rootfs/lava-*/environment | head -n1) 
. "$env_file" 

TFTP_BASE="/srv/tftp" 
JOB_DIR="${TFTP_BASE}/${LAVA_JOB_ID}/tftp-deploy-*" 

KERNEL=$(find $JOB_DIR/kernel -name 'Image' | head -n1) 
DTB=$(find $JOB_DIR/dtb -name '*.dtb' | head -n1) 
INITRAMFS=$(find $JOB_DIR/ramdisk -name '*.img' | head -n1) 

if [ -z "$KERNEL" ] || [ -z "$DTB" ]; then 
    echo "Error: kernel or dtb not found for job $LAVA_JOB_ID" 
    exit 1 
fi 

sudo -S rm -f "${TFTP_BASE}/pxelinux.cfg/01-fe-fe-fe-00-06-6e" << EOF 
zhtianyu\r 
EOF 

sudo -S cp /home/zhtianyu/bpi_f3/01-fe-fe-fe-00-06-6e "${TFTP_BASE}/pxelinux.cfg/01-fe-fe-fe-00-06-6e" << EOF 
zhtianyu\r 
EOF 

KERNEL_REL=${KERNEL#$TFTP_BASE/} 
DTB_REL=${DTB#$TFTP_BASE/} 
INITRAMFS_REL=${INITRAMFS#$TFTP_BASE/} 

sudo -S sed -i \ 
    -e "s|{KERNEL}|${KERNEL_REL}|g" \ 
    -e "s|{DTB}|${DTB_REL}|g" \ 
    -e "s|{INITRAMFS}|${INITRAMFS_REL}|g" \ 
    "${TFTP_BASE}/pxelinux.cfg/01-fe-fe-fe-00-06-6e" << EOF 
zhtianyu\r 
EOF 

echo "Generated pxelinux.cfg for job $LAVA_JOB_ID" 
echo "Kernel: $KERNEL" 
echo "DTB: $DTB"
```

当开发板通过 PXE 启动时，bootloader 会按以下顺序寻找配置文件：

1. `pxelinux.cfg/01-xx-xx-xx-xx-xx-xx`（具体 MAC 地址）
2. `pxelinux.cfg/C0A80102`（客户端 IP 的十六进制形式）
3. `pxelinux.cfg/default`（默认配置）

所以，文件 `/srv/tftp/pxelinux.cfg/01-fe-fe-fe-00-06-6e`就是针对该板子网卡 ​**专属的启动配置**​。

## 为设备编写 Device 文件

新建 k1-bananapi-f3 设备的 Device Dictionary 文件，将其存储在 server 下的 `/etc/lava-server/dispatcher-config/devices/k1-bananapi-f3-01.jinja2` 中

⚠️ **这里的 jinja2 文件名称需要和新添加的 Device 名称保持一致**

### 向 LAVA 描述如何连接远端串口

在配置完成 sg2042 的 ser2net 连接方式之后，为`sg2042-01.jinja2`添加[通过串口方式连接](https://docs.lavasoftware.org/lava/connections.html?highlight=ssh#configuring-serial-ports)的描述

```Shell
{% set connection_list = ['uart0'] %}  
{% set connection_commands = {'uart0': 'telnet localhost 15203'} %}  
{% set connection_tags = {'uart0': ['primary', 'telnet']} %}
```

### 向 LAVA 描述如何控制设备开关机

配置 sg2042 的 home-assistant 之后，为`sg2042-01.jinja2`添加控制设备开关机的描述

```Shell
{% set power_off_command = '/home/zhtianyu/bpi_f3/power_off' %}  
{% set power_on_command = '/home/zhtianyu/bpi_f3/power_on' %}  
{% set hard_reset_command = '/home/zhtianyu/bpi_f3/hard_reset' %}  
{% set soft_reset_command = '/home/zhtianyu/bpi_f3/hard_reset' %}
```

### 设置 persistent\_nfs 服务端 ip ，以及重置 rootfs 的脚本和配置 pxelinux.cfg 的脚本

```Shell
{% set static_info = [{'FILE_SERVER_IP': "10.213.5.176"}] %}
{% set pxelinux_generate = '/home/zhtianyu/bpi_f3/generate_pxelinux' %} 
{% set pre_os_command = '/home/zhtianyu/bpi_f3/reset_nfsrootfs' %} 

{% set user_commands = {'pxelinux_generate': {'do': '/home/zhtianyu/bpi_f3/generate_pxelinux', 'undo': 'echo "noop"'}, 
                        'pre_os_command': {'do': '/home/zhtianyu/bpi_f3/reset_nfsrootfs', 'undo': 'echo "noop"'}} %}
```

最后 `/etc/lava-server/dispatcher-config/devices/sg2042-01.jinja2` 中内容应该类似：

```Shell
{% extends 'spacemit-k1-bananapi-f3.jinja2' %} 

{% set device_type = 'spacemit-k1-bananapi-f3' %}  

{% set connection_list = ['uart0'] %}  
{% set connection_commands = {'uart0': 'telnet localhost 15203'} %}  
{% set connection_tags = {'uart0': ['primary', 'telnet']} %}  

{% set static_info = [{'FILE_SERVER_IP': "10.213.5.176"}] %} 

{% set power_off_command = '/home/zhtianyu/bpi_f3/power_off' %}  
{% set power_on_command = '/home/zhtianyu/bpi_f3/power_on' %}  
{% set hard_reset_command = '/home/zhtianyu/bpi_f3/hard_reset' %}  
{% set soft_reset_command = '/home/zhtianyu/bpi_f3/hard_reset' %} 

{% set pxelinux_generate = '/home/zhtianyu/bpi_f3/generate_pxelinux' %} 
{% set pre_os_command = '/home/zhtianyu/bpi_f3/reset_nfsrootfs' %} 

{% set user_commands = {'pxelinux_generate': {'do': '/home/zhtianyu/bpi_f3/generate_pxelinux', 'undo': 'echo "noop"'}, 
                        'pre_os_command': {'do': '/home/zhtianyu/bpi_f3/reset_nfsrootfs', 'undo': 'echo "noop"'}} %}
```

### device type template 与 device dictionary 的关系

#### device type template（设备类型模板）

* ​**定义位置**​：通常在 `/etc/lava-server/dispatcher-config/device-types/` 目录下。
* ​**内容**​：是 Jinja2 模板（`.jinja2`），描述某一类设备（如 qemu、rpi4、hikey、x86）的通用特性，比如 spacemit-k1-bananapi-f3.jinja2 中的部分配置：
  继承了`base-uboot.jinja2`，即复用了 U-Boot 的**通用配置，再加上 spacemit-k1-bananapi-f3 设备的专用设置**
  
  配置了设置控制台设备和波特率
  
  设置内存地址。
* ​**特点**​：
  
  * 通用模板，不绑定某一台 BPI-F3，而是 ​**所有 BPI-F3 设备共用**​。
  * 提供统一的部署/启动/测试逻辑。
  * 可以通过 **变量覆盖 ​**来自字典文件。

#### device dictionary（设备字典）

* ​**定义位置**​：通常在 `/etc/lava-server/dispatcher-config/devices/` 目录下，每台真实设备一个 jinja2 文件。
* ​**内容**​：描述某一台 **具体设备** 的信息，比如`k1-bananapi-f3-01.jinja2`：
  
  * **继承关系**`extends 'spacemit-k1-bananapi-f3.jinja2'`  → 说明这个具体设备基于 `spacemit-k1-bananapi-f3.jinja2`（也就是 `spacemit-k1-bananapi-f3` 的设备类型模板），继承了模板里的所有通用配置。
  * **设备唯一信息**
    ​**connection\_list / connection\_commands**​：定义了串口连接方式，使用 telnet 本地端口 `15203`访问 UART。
    ​**​     connection\_tags**​：标记 uart0 是主连接（primary），使用 telnet。
  
  ​**​     power\_on/off/reset/pre\_os\_command**​：指定如何控制这台设备的电源和复位，以及测试前重置 persistent\_nfs，用的是本地脚本（如`/home/zhtianyu/bpi_f3/power_on` 等）。
* ​**特点**​：它是实例化的，一台设备一个文件，​**文件名称对应具体 device 的 hostname**​。

## spacemit-k1-bananapi-f3 job

```YAML
device_type: spacemit-k1-bananapi-f3
job_name: spacemit-k1-bananapi-f3-LTP-Math-Test
timeouts:
  job:
    minutes: 10300
  action:
   minutes: 10299
  actions:
    power-off:
      seconds: 60
priority: medium
visibility: public
metadata:
  # please change these fields when modifying this job for your own tests.
  format:
  name:
  description: ""
  version: "1.0"
# ACTION_BLOCK
actions:
- command:
    name: pre_os_command
    timeout:
      minutes: 20
# DEPLOY_BLOCK
- deploy:
    timeout:
      minutes: 120
    to: tftp
    dtb:
      url: https://fast-mirror.isrc.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/RVCK/OERV-RVCI/RVCK-Project/rvck-olk/33_3430781350/lib/dtbs/spacemit/k1-bananapi-f3.dtb
    kernel:
      url: https://fast-mirror.isrc.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/RVCK/OERV-RVCI/RVCK-Project/rvck-olk/33_3430781350/Image
      type: image
    ramdisk:
      url: https://fast-mirror.isrc.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/RVCK/OERV-RVCI/RVCK-Project/rvck-olk/33_3430781350/initramfs.img
      install_overlay: False
      install_modules: False
    persistent_nfs:
      address: "{FILE_SERVER_IP}:/var/lib/lava/dispatcher/tmp/k1_rootfs"
- command:
    name: pxelinux_generate
    timeout:
      minutes: 20
# BOOT_BLOCK
- boot:
    timeout:
      minutes: 30
    method: minimal
    soft_reboot:
    - root
    - openEuler
    - reboot
    - The system will reboot now!
    prompts: ["root@openeuler-riscv64", "login:", "Password:"]
    auto_login:
      login_prompt: "(.*)openeuler-riscv64 login:(.*)"
      username: root
      password_prompt: "Password:"
      password: openEuler12#$
# TEST_BLOCK
- test:
      timeout:
        minutes: 10109
      definitions:
        - repository: https://github.com/RVCK-Project/lavaci.git
          from: git
          name: ltp-math-k1
          path: lava-testcases/common-test/ltp/ltp.yaml
          parameters:
            TST_CMDFILES: math
```

### spacemit-k1-bananapi-f3 的 Job 基础配置

spacemit-k1-bananapi-f3 的 Job 基础配置，包括 device\_type 和 job\_name 等描述。

```YAML
device_type: spacemit-k1-bananapi-f3
job_name: spacemit-k1-bananapi-f3-LTP-Math-Test
timeouts:
  job:
    minutes: 10300
  action:
   minutes: 10299
  actions:
    power-off:
      seconds: 60
priority: medium
visibility: public
metadata:
  # please change these fields when modifying this job for your own tests.
  format:
  name:
  description: ""
  version: "1.0"
```

### 测试前清理上次测试的残留

pre\_os\_command 为清理上次测试的残留，并解压出一个干净的 rootfs，pre\_os\_command 脚本在 device 文件中配置好，并且在 worker 上准备好。

```Shell
# ACTION_BLOCK
- command:
    name: pre_os_command
    timeout:
          minutes: 20
```

### deploy 阶段

定义 kernel, initramfs.img 和 dtb 文件通过 tftp 从 worker 加载到设备并启动，persistent\_nfs 为之前在 worker 的上配置好的 rootfs 目录。其中的 FILE\_SERVER\_IP 是在 device dictionary 中配置好的。另外运行 pxelinux\_generate 脚本用于准备 pxelinux.cfg 配置

```YAML
# DEPLOY_BLOCK
- deploy:
    timeout:
      minutes: 120
    to: tftp
    dtb:
      url: https://fast-mirror.isrc.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/RVCK/OERV-RVCI/RVCK-Project/rvck-olk/33_3430781350/lib/dtbs/spacemit/k1-bananapi-f3.dtb
    kernel:
      url: https://fast-mirror.isrc.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/RVCK/OERV-RVCI/RVCK-Project/rvck-olk/33_3430781350/Image
      type: image
    ramdisk:
      url: https://fast-mirror.isrc.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/RVCK/OERV-RVCI/RVCK-Project/rvck-olk/33_3430781350/initramfs.img
      install_overlay: False
      install_modules: False
    persistent_nfs:
      address: "{FILE_SERVER_IP}:/var/lib/lava/dispatcher/tmp/k1_rootfs"
```

### boot 和 test 阶段：启动待测试的 kernel 和 dtb 文件并进行测试

因为 bpi-f3 默认启动会直接获取 pxe 配置文件，无需进行额外操作， method 设置为 minimal 即可，登陆后执行测试

```YAML
# BOOT_BLOCK
- boot:
    timeout:
      minutes: 30
    method: minimal
    soft_reboot:
    - root
    - openEuler
    - reboot
    - The system will reboot now!
    prompts: ["root@openeuler-riscv64", "login:", "Password:"]
    auto_login:
      login_prompt: "(.*)openeuler-riscv64 login:(.*)"
      username: root
      password_prompt: "Password:"
      password: openEuler12#$
# TEST_BLOCK
- test:
      timeout:
        minutes: 10109
      definitions:
        - repository: https://github.com/RVCK-Project/lavaci.git
          from: git
          name: ltp-math-k1
          path: lava-testcases/common-test/ltp/ltp.yaml
          parameters:
            TST_CMDFILES: math
```

## 在同一台 worker 上接入两台 k1 同时运行任务出现并行 NFS 丢锁的问题

目前在同一台 worker 上接入两台 k1 同时运行任务出现并行 NFS 丢锁的问题，尝试 k1 + lpi4a/sg2042 同时运行任务未发现此问题。两台 lpi4a/sg2042 在同一台 worker 上同时运行任务暂未实验，推测有同样的问题。

```
NFS: 10.213.5.176: lost 1 locks
```